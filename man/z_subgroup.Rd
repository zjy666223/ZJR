% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/z_subgroup.R
\name{z_subgroup}
\alias{z_subgroup}
\title{z_subgroup: Cox subgroup analysis table with interaction P (heterogeneity)}
\usage{
z_subgroup(
  exposure_data,
  outcome_data,
  cov_data,
  exposure_col,
  id = NULL,
  time_col = NULL,
  event_col = NULL,
  subgroup_factors = c("ethnicity", "drinking_status", "BMI", "smoking_status",
    "physical_activity", "diabetes", "hypertension", "asthma", "sleep_cat"),
  model_t2,
  na_codes = c(-1, -2, -3, -7, -8, -9),
  ties = "efron"
)
}
\arguments{
\item{exposure_data}{Data frame/table containing ID and the exposure column.}

\item{outcome_data}{Data frame/table containing ID, time and event columns.}

\item{cov_data}{Data frame/table containing ID, covariates and subgroup variables.}

\item{exposure_col}{Character. Exposure column name (e.g. \code{"twa_benzene"} or \code{"twa_benzene_s"}).}

\item{id}{Character. ID column name. If \code{NULL}, auto-detected
among \code{c("eid","ID","id","participant_id")}.}

\item{time_col}{Character. Time column name. If \code{NULL}, auto-detected
among \code{c("all_cause_time","AR_time","time","followup_time","fu_time")}.}

\item{event_col}{Character. Event column name. If \code{NULL}, auto-detected
among \code{c("all_cause_status","AR_status","status","event","case")}.}

\item{subgroup_factors}{Character vector. Subgroup variables to iterate, e.g.
\code{c("ethnicity","drinking_status","BMI","smoking_status", "physical_activity","diabetes","hypertension","asthma","sleep_cat")}.}

\item{model_t2}{List of length 2 with covariate vectors:
\code{list(model_1_covars, model_2_covars)}.}

\item{na_codes}{Values treated as NA for subgroup factors (default UKB codes:
\code{c(-1, -2, -3, -7, -8, -9)}).}

\item{ties}{Cox ties handling, default \code{"efron"}.}
}
\value{
A \code{data.frame} with columns:
\itemize{
\item \code{subgroups} — subgroup name + level (concatenated)
\item \code{expose}, \code{outcome}
\item \code{Case_N}, \code{Control_N}, \code{Person_years}
\item \code{model_1.HR}, \code{model_1.95._CI}, \code{model_1.P.value}
\item \code{model_2.HR}, \code{model_2.95._CI}, \code{model_2.P.value}
\item \code{model_1_hets}, \code{model_2_hets} — P for interaction (LRT) on full data
}
}
\description{
Build a publication-ready \strong{subgroup table} for Cox proportional hazards models.
It merges exposure/outcome/covariate datasets by ID, fits two prespecified
adjustment models (model 1 & model 2) \strong{within each level of each subgroup}
and reports HR (95\% CI) and P-value. It also computes an \strong{overall
heterogeneity test} (likelihood ratio test of the interaction term
\code{exposure * subgroup}) on the full dataset.

Robustness details:
\itemize{
\item Accepts \code{data.frame} and \code{data.table} seamlessly (internally coerced).
\item Auto-detects ID/time/event column names when not provided.
\item When stratifying by a subgroup \code{sg}, that subgroup is \strong{removed from the
covariate set} for within-level fits (avoids singular/constant columns),
while it is kept for the full-sample interaction test.
\item Inside each subgroup level, covariates that become \strong{constant} are pruned.
\item Skips non-estimable strata (too few rows, no events/controls); no crash.
}
}
\section{Why some NA used to appear and how it's fixed}{

When stratifying by a subgroup (e.g., \code{BMI}), including the same variable in
the covariate set for within-level models makes it \strong{constant} inside that
stratum, causing singularities or dropped columns, which led to \code{NA} HR/CI.
This function \strong{removes the current subgroup from covariates} for the
within-level fits and \strong{prunes constant covariates} per level, eliminating
those spurious \code{NA}s. The interaction P is still computed on the
\strong{full sample} with \code{exposure * subgroup}.
}

\examples{
\dontrun{
# Prepare models
model_a <- c("age","gender")
model_b <- c(model_a,"ethnicity","BMI","education","household_income",
             "smoking_status","drinking_status","score_diet","physical_activity","discoast")
model_t2 <- list(model_a, model_b)

# Minimal explicit usage (recommended to avoid auto-detect ambiguity)
sub_tbl <- z_subgroup(
  exposure_data, outcome_data, cov_data,
  exposure_col = "twa_benzene",
  id = "eid",
  time_col = "all_cause_time",
  event_col = "all_cause_status",
  model_t2 = model_t2,
  subgroup_factors = c("ethnicity","drinking_status","BMI",
                       "smoking_status","physical_activity",
                       "diabetes","hypertension","asthma","sleep_cat")
)
# data.table::fwrite(sub_tbl, "subgroup_table.csv")
}

}
